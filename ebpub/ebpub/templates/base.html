{% comment %}<!-- -*- mode: django-html; tab-width: 4 -*- -->{% endcomment %}
{% load eb %}{% load django_static %}
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
<title>{% block fulltitle %}{% block title %}{% endblock %} | {% block city_title %}OpenBlock{% endblock %}{% endblock fulltitle %}</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="robots" content="noarchive">
<link rel="home" title="Home" href="{% url ebpub-homepage %}">

{% slimall %}
<link rel="stylesheet" type="text/css" href="/styles/style-reset.css" />
<link rel="stylesheet" type="text/css" href="/styles/openblock.css" />
{% endslimall %}

<script src="{{ JQUERY_URL }}" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript">
// Not using jquery.noConflict() because ironically it causes a conflict
// with OpenLayers and we end up with the $ function from OpenLayers. 
// But a lot of existing everyblock code expects $j instead of $
var $j = $;
</script>
{% slimall %}
<script src="/scripts/ob-jquery-csrf.js" type="text/javascript" charset="utf-8"></script>
{% endslimall %}

<!-- ArcGIS -->
<script type="text/javascript">var djConfig = {parseOnLoad: true};</script>
<script type="text/javascript" src="http://serverapi.arcgisonline.com/jsapi/arcgis/?v=2.8compact"></script>
<style type="text/css">
#detailmap_infowindow div .window{
	display: none;
}
#content{
	width: 380px;
}
#nav-location{
	width: 500px;
}
#nav-breadcrumb li:last-child{
	background: none;
}
</style>
<link href="http://serverapi.arcgisonline.com/jsapi/arcgis/2.8/js/dojo/dijit/themes/claro/claro.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">
dojo.require("dijit.layout.ContentPane");
dojo.require("esri.map");
dojo.require("esri.layers.agstiled");
dojo.require("esri.layers.graphics");
dojo.require("esri.layers.FeatureLayer");
dojo.require("esri.arcgis.utils");
dojo.require("esri.layers.KMLLayer");

var map, incidentsGraphicsLayer, initExtent;

function mapinit() {
	initExtent = new esri.geometry.Extent({
		"xmin":-83.702193,
		"ymin":32.781055,
		"xmax":-83.54538,
		"ymax":32.892187,
		"spatialReference":{"wkid":4326}
	});
	initExtent = initExtent.expand(1.5);
	var urlObject = esri.urlToObject(document.location.href);
	if(urlObject.query && urlObject.query.webmap){
		var b=esri.arcgis.utils.createMap(
			urlObject.query.webmap,
			"detailmap",
			{
				mapOptions: {
					slider:true,
					nav:false,
					wrapAround180:true
				}
			});
		b.addCallback(function(e){
			map=e.map;
			if(map.loaded){
				onMapLoaded();
			}
			else{
				dojo.connect(map,"onLoad",onMapLoaded);
			}
		});
		b.addErrback(function(e){
			console.log("CreateMap failed: ",dojo.toJson(e));
			alert(dojo.toJson(e));
		});
	}
	else{
		map = new esri.Map("detailmap",{
			extent: esri.geometry.geographicToWebMercator(initExtent),
			minZoom: 10
		});
		onMapLoaded();
	}
}
function onMapLoaded(){
	map.setExtent( esri.geometry.geographicToWebMercator(initExtent), true );

	//Add the topographic layer to the map. View the ArcGIS Online site for services http://arcgisonline/home/search.html?t=content&f=typekeywords:service 
	var urlObject = esri.urlToObject(document.location.href);
	if(!urlObject.query || !urlObject.query.webmap){
		if(urlObject.query && urlObject.query.watercolor){
			// custom watercolor look
			var osmLayer = new esri.layers.OpenStreetMapLayer({ tileServers: [ "http://c.tile.stamen.com/watercolor" ] });
			map.addLayer(osmLayer);
		}
		else{
			// Use Esri Terrain Basemap
			//var basemap = new esri.layers.ArcGISTiledMapServiceLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer");
			var basemap = new esri.layers.ArcGISTiledMapServiceLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer");
			map.addLayer(basemap);

			//Add Bibb County features
			if($("#nav-breadcrumb").children().length > 1){
				//Add Bibb County GIS
				var bibb = new esri.layers.ArcGISTiledMapServiceLayer("http://gis.co.bibb.ga.us/ArcGISBibb/rest/services/AG4LG/ParcelPublicAccess/MapServer");
				map.addLayer(bibb);

				// Add custom river polygon
				setTimeout(function(){
					var river = [[-83.5983085,32.8171797],[-83.5981339,32.8185682],[-83.5984497,32.8199344],[-83.5999182,32.822609],[-83.6012492,32.8241264],[-83.6024046,32.8249939],[-83.6044705,32.8261653],[-83.6063582,32.827738],[-83.6075192,32.8287364],[-83.6103222,32.8319704],[-83.6134345,32.8344794],[-83.6208757,32.8384531],[-83.6243647,32.8404721],[-83.624993,32.8410675],[-83.6272684,32.8440333],[-83.6290559,32.846071],[-83.6299357,32.8473796],[-83.6322928,32.8497096],[-83.6335141,32.8505418],[-83.6345214,32.8517548],[-83.635626,32.8557509],[-83.6364492,32.8575087],[-83.6376389,32.8589587],[-83.6383959,32.8594922],[-83.6400502,32.8602265],[-83.6430879,32.8604962],[-83.6451844,32.8612803],[-83.6474455,32.8628808],[-83.6522951,32.8651321],[-83.6542949,32.8670339],[-83.6545631,32.8679665],[-83.6544483,32.8689875],[-83.6534911,32.8709816],[-83.6521457,32.8725571],[-83.6513614,32.8731316],[-83.6507338,32.8727434],[-83.6524371,32.8710758],[-83.6534002,32.869276],[-83.6535609,32.8674425],[-83.6527489,32.8664116],[-83.651049,32.8651628],[-83.6469079,32.8634425],[-83.6441122,32.8615988],[-83.6428299,32.861254],[-83.6398495,32.8608901],[-83.6371988,32.8596527],[-83.6362236,32.8585152],[-83.6351456,32.8567754],[-83.6345624,32.8553422],[-83.6341969,32.8536928],[-83.63333,32.8518785],[-83.6324826,32.8508819],[-83.6306362,32.8493992],[-83.6289834,32.847687],[-83.6277472,32.8459519],[-83.6272682,32.8455534],[-83.6254932,32.8428082],[-83.6245098,32.8417159],[-83.6234458,32.8407238],[-83.6224252,32.840069],[-83.6150283,32.8362438],[-83.6121568,32.8345005],[-83.6088691,32.8319275],[-83.6068604,32.8294334],[-83.6053604,32.8280656],[-83.6049373,32.8280304],[-83.6049433,32.8278112],[-83.6044236,32.8271313],[-83.6036563,32.8265697],[-83.6016573,32.8255405],[-83.5999751,32.8242159],[-83.5975878,32.8201657,0],[-83.5983085,32.8171797]];
					var polygonJson = { "rings": [ river ], "spatialReference": {"wkid":4326} };
					var polygon = new esri.geometry.Polygon(polygonJson);
					polygon = esri.geometry.geographicToWebMercator( polygon );
					var symbol = new esri.symbol.SimpleFillSymbol("solid", new esri.symbol.SimpleLineSymbol("solid", new dojo.Color([0,0,255,0.6]), 1), new dojo.Color([100,100,255,0.35]));
					map.graphics.add( new esri.Graphic( polygon, symbol ));
				}, 500);
			}
		}
	}

	dojo.connect(map, "onLoad", function(){
		dojo.connect(dijit.byId('map'), 'resize', map,map.resize);
	});
	loadMap();
}
dojo.addOnLoad(mapinit);
</script>

<!-- begin block extrahead -->
{% block extrahead %}{% endblock %}
<!-- end block extrahead -->

<style type="text/css">
#detailmap{
	width:100%;
	height:100%;
	padding:0;
	margin:0;
}
body{
	background: transparent url(http://i.imgur.com/fxBx3.png) top left;
}
#header{
	background-color:#fff;
}
#nav-location{
	background-color:#fff;
	padding:10px;
	margin:-10px;
	border-radius:6px;
	border: 4px solid #fff;
	border-left:none;
}
#content{
	background-color:#fff;
	padding:10px;
	margin:-10px;
	border-radius:6px;
	border: 4px solid #fff;
	border-right:none;
}
#container{
	background:#fff;
	background-color:#fff;
}
ul#nav-breadcrumb, #nav-breadcrumb li{
	color:#fff;
	background-color:#000;
}
</style>

</head>
<body {% if bodyid %}id="{{bodyid}}"{% endif %} {% if bodyclass %}class="{{bodyclass}}"{% endif %}>
  <div id="container">
	<div id="header">
		<h1><a href="{% url ebpub-homepage %}">OpenBlock: {% METRO_NAME %}</a></h1>
		<div id="globalnav">
		    <!--
			<ul>
				<li><a href="/news/">News</a></li>
				<li><a href="/locations/">Locations</a></li>
			</ul>
			-->
			{% block userlinks %}
			<div id="userlinks">
			  {% if USER_EMAIL %}
			  <form action="{% url ebpub.accounts.views.logout %}" method="POST">
				{% csrf_token %}
				<p>Logged in as <a href="{% url ebpub.accounts.views.dashboard %}">{{ USER_EMAIL }}</a>. <button type="submit">Log out</button></p>
			  </form>
			  {% else %}
			  <p><a href="{% url ebpub.accounts.views.login %}" rel="nofollow">Sign in</a> or <a href="{% url ebpub.accounts.views.register %}" rel="nofollow">register</a> for extra features</p>
			  {% endif %}
			</div><!--/ #userlinks -->
			{% endblock userlinks %}
			{% set_search_placeholder "Search for" as placeholder %}
			<form action="{% url ebpub-search %}" id="globalsearch" onsubmit="if ($j('#searchinput').val() == '{{ placeholder }}') return false; return true;">
				<p>
					<label for="searchinput">{{ placeholder}}</label>
					<input type="text" id="searchinput" name="q" value="{{ placeholder }}" onfocus="if (this.value == '{{ placeholder }}') { this.value = ''; }" onblur="if (this.value == '') { this.value = '{{ placeholder }}'; }">
					<button type="submit">Go</button>
				</p>
			</form>
		</div><!--/ #globalnav -->
		<!-- begin block breadcrumbs -->
		{% block breadcrumbs %}
		{% include "db/snippets/breadcrumbs.html" %}
		{% endblock breadcrumbs %}
		<!-- end block breadcrumbs -->
	</div><!-- / #header -->
	<div id="main">
	  <!-- begin block messages -->
		{% block messages %}
	    {% if messages %}
	    <ul class="messages">
		  {% for message in messages %}
		  <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
		  {% endfor %}
		</ul>
		{% endif %}
		{% endblock messages %}
        <!-- end block messages -->
		<!-- begin block content -->
		{% block content %}{% endblock content %}
		<!-- end block content -->
	</div><!-- / #main -->
  </div><!-- / #container -->
</body>
</html>
